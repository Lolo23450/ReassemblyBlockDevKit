<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reassembly Block Development Kit</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: white; color: black; transition: background 0.3s, color 0.3s; }
        .container { display: flex; }
        .panel { width: 50%; padding: 10px; border: 1px solid #c0bcbc; margin-right: 10px; background: white; transition: background 0.3s; }
        .block-list button { display: block; margin: 6px; padding: 10px; width: 97%; transition: background 0.25s, color 0.25s; }
        .attribute-section { margin-top: 10px; }
        label { width: 97%; display: inline-block; margin-top: 2px; margin-bottom: 2px; }
        input, select { width: 100%; padding: 3px; margin-bottom: 3px; }
        #exportBtn, #creditsBtn, #loadBtn, #darkModeBtn { margin-top: 10px; padding: 10px; background: green; color: white; border: none; cursor: pointer; }
        #creditsBtn { background: blue; }
        #loadBtn { background-color: green; }
        #darkModeBtn { background-color: blue; }
        #creditsPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); }
        #closeCredits { margin-top: 10px; padding: 5px; background: red; color: white; border: none; cursor: pointer; }
        
        /* Dark Mode Styles */
        body.dark-mode { background: #1e1e1e; color: white; }
        /* input.dark-mode, select { width: 100%; padding: 5px; margin-bottom: 5px; background: #1e1e1e; color: white; transition: background 0.25s, color 0.25s; } */
        .panel.dark-mode { background: #333; border-color: #666; }
        .block-list.dark-mode button { display: block; margin: 6px; padding: 10px; width: 97%; background: #1e1e1e; color: white;}
        .dark-mode #creditsPopup {display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; padding: 20px; border: 1px solid black; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <h1>Reassembly Block Development Kit</h1>
    <button id="creditsBtn" onclick="showCredits()">Credits</button>
    <button id="darkModeBtn" onclick="toggleDarkMode()">Toggle Dark/Light Mode</button>
    <button id="exportBtn" onclick="exportBlocks()">Export blocks.lua</button>
    <button id="loadBtn" onclick="loadBlocks()">Load blocks.lua (WIP)</button>
    <div id="creditsPopup">
        <h2>Credits</h2>
        <p>Developed by: Lolo</p>
        <p>Contributors: ChatGPT, Copilot</p>
        <button id="closeCredits" onclick="closeCredits()">Close</button>
    </div>
    <div class="container">
        <div class="panel block-list">
            <h3>1- Select a Block Type</h3>
            <button onclick="selectBlock('Armor')">Armor</button>
            <button onclick="selectBlock('Cannon')">Cannon</button>
            <button onclick="selectBlock('Laser')">Laser</button>
            <button onclick="selectBlock('Generator')">Generator</button>
            <button onclick="selectBlock('Command')">Command Module</button>
            <button onclick="selectBlock('Thruster')">Thruster</button>
            <button onclick="selectBlock('Factory')">Factory</button>
            <button onclick="selectBlock('Shield')">Shield</button>
            <button onclick="selectBlock('Tractor')">Tractor</button>
        </div>
        <div class="panel">
            <h3>2- Select Block Attributes</h3>
            <div id="blockattributes"></div>
            <div id="attributes"></div>
            <div id="shroudSection" style="display: none;">
                <h3>Shrouds</h3>
                <ul id="shroudList"></ul>
            </div>
            <div id="fragmentSection" style="display: none;">
                <h3>Fragments (WIP, Only 1 Fragment per Cannon)</h3>
                <ul id="fragmentList"></ul>
            </div>
            <button id="exportBtn" onclick="exportBlocks()">Export blocks.lua</button>
        </div>
        <div class="panel block-list">

            <h3>Created Blocks</h3>
            <ul id="blockList"></ul>
        </div>
    </div>

    <script>

        let blocks = [];

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            document.querySelectorAll(".panel").forEach(panel => panel.classList.toggle("dark-mode"));
            document.querySelectorAll("input").forEach(input => input.classList.toggle("dark-mode"))
            document.getElementById('creditsPopup').classList.toggle('dark-mode');
        }
        
        function showCredits() {
            document.getElementById('creditsPopup').style.display = 'block';
        }

        function closeCredits() {
            document.getElementById('creditsPopup').style.display = 'none';
        }

        function selectBlock(typeargs, generalargs) {
            renderAttributes({ typeargs, generalargs, name: `New ${typeargs}`, shape: "SQUARE", size: 1, id: blocks.length + 1, group: 1, fillColor1: "#d4d4d4", fillColor2: "#959696", lineColor: "#686869", capacity: 0, cannondmg: 20, cannonrounds: 4, cannonrange: 800, cannonvel: 1000, cannonpower: 7, laserdmg: 100, laserrange: 700, laserwidth: 2, laserpower: 5, lasercolor: "#ffffff", turreted: "True", health: 1, powerCapacity: 300, generatorCapacityPerSec: 75, faction: 1, thrust: 30000, points: 0, shieldradius: 40, shieldpower: 0, shieldhealth: 300, shieldregen: 100, shielddelay: 2, shieldcolor: "#00ff00", shielddamagedColor: "#ff0000", density: 1, shroudsize: 2, shroudoffset: "{0,0,0}", shroudtaper: 1, shroudshape: "SQUARE", tractorRange: 500});
        }

        function renderAttributes(block) {
            const shroudSection = document.getElementById('shroudSection');
            shroudSection.style.display = 'block';
            const featureAttributesDiv = document.getElementById('attributes');
            const blockAttributesDiv = document.getElementById('blockattributes');
            const shroudList = document.getElementById('shroudList');
            const fragmentList = document.getElementById('fragmentList');
            featureAttributesDiv.innerHTML = `<h4>${block.typeargs} Attributes</h4>`;
            blockAttributesDiv.innerHTML = `<h5>General Attributes</h5>`;
            let blockAttributesHTML = `<label>Name: <input type="text" id="name" value="${block.name}"></label>`;
            blockAttributesHTML += `<label>Block ID: <input type="number" id="id" value="${block.id}"></label>`;
            blockAttributesHTML += `<label>Group/Faction ID: <input type="text" id="group" value="${block.group}"></label>`;
            blockAttributesHTML += `<label>Shape: <input type="text" id="shape" value="${block.shape}"></label>`;
            blockAttributesHTML += `<label>Size: <input type="number" id="size" value="${block.size}"></label>`;
            blockAttributesHTML += `<label>Health Multiplier: <input type="number" id="health" value="${block.health}"></label>`;
            blockAttributesHTML += `<label>Density/Mass Multiplier: <input type="number" id="density" value="${block.density}"></label>`;
            blockAttributesHTML += `<label>Capacity: <input type="number" id="capacity" value="${block.capacity}"></label>`;
            blockAttributesHTML += `<label>P Cost: <input type="number" id="points" value="${block.points}"></label>`;
            blockAttributesHTML += `<label>Fill Color 1: <input type="color" id="fillColor1" value="${block.fillColor1}"></label>`;
            blockAttributesHTML += `<label>Fill Color 2: <input type="color" id="fillColor2" value="${block.fillColor2}"></label>`;
            blockAttributesHTML += `<label>Line Color: <input type="color" id="lineColor" value="${block.lineColor}"></label>`;
            shroudList.innerHTML = "";
            let shroudListHTML = `<button onclick="addShroud()">Add Shroud</button>`;
            let attributesHTML = '';
            
            if (block.typeargs === 'Cannon') {
                fragmentSection.style.display = 'block';
                attributesHTML += `
                    <label>Turreted: <select id="turreted">
                        <option value="True" ${block.turreted === "True" ? "selected" : ""}>True</option>
                        <option value="False" ${block.turreted === "False" ? "selected" : ""}>False</option>
                    </select></label>
                    <label>Damage: <input type="number" id="damage" value="${block.cannondmg}"></label>
                    <label>Rounds per Sec: <input type="number" id="roundsPerSec" value="${block.cannonrounds}"></label>
                    <label>Range: <input type="number" id="range" value="${block.cannonrange}"></label>
                    <label>Shot Velocity: <input type="number" id="muzzleVel" value="${block.cannonvel}"></label>
                    <label>Power: <input type="number" id="power" value="${block.cannonpower}"></label>
                    <label>Spread (0-3.6): <input type="number" id="spread" min="0" max="3.6" step="0.1" value="${block.spread || 0}" oninput="this.value = Math.min(Math.max(this.value, 0), 3.6)"></label>
                    <label>Projectile Size (1-100): <input type="number" id="projectileSize" min="1" max="100" value="${block.projectileSize || 1}" oninput="this.value = Math.min(Math.max(this.value, 1), 100)"></label>
                    <label>Rounds per Burst (1-100): <input type="number" id="roundsPerBurst" min="1" max="100" value="${block.roundsPerBurst || 1}" oninput="this.value = Math.min(Math.max(this.value, 1), 100)"></label>
                    <label>Burstyness (0-1): <input type="number" id="burstiness" min="0" max="1" step="0.1" value="${block.burstiness || 0}" oninput="this.value = Math.min(Math.max(this.value, 0), 1)"></label>
                `;
            } else if (block.typeargs === 'Laser') {
                attributesHTML += `
                    <label>Turreted (True/False): <input type="text" id="turreted" value="${block.turreted}"></label>
                    <label>Damage: <input type="number" id="laserdamage" value="${block.laserdmg}"></label>
                    <label>Range: <input type="number" id="laserrange" value="${block.laserrange}"></label>
                    <label>Width: <input type="number" id="laserwidth" value="${block.laserwidth}"></label>
                    <label>Power: <input type="number" id="laserpower" value="${block.laserpower}"></label>
                    <label>Color: <input type="color" id="lasercolor" value="${block.lasercolor}"></label>
                `;
            } else if (block.typeargs === 'Generator') {
                attributesHTML += `
                    <label>Power Capacity: <input type="number" id="powerCapacity" value="${block.powerCapacity}"></label>
                    <label>Generation per Sec: <input type="number" id="generatorCapacityPerSec" value="${block.generatorCapacityPerSec}"></label>
                `;
            } else if (block.typeargs === 'Command') {
                attributesHTML += `
                    <label>Faction ID: <input type="number" id="faction" value="${block.faction}"></label>
                `;
            } else if (block.typeargs === 'Thruster') {
                attributesHTML += `
                    <label>Thruster Force: <input type="number" id="thrust" value="${block.thrust}"></label>
                `;
            } else if (block.typeargs === 'Shield') {
                attributesHTML += `
                    <label>Radius: <input type="number" id="radius" value="${block.shieldradius}"></label>
                    <label>Health: <input type="number" id="shieldhealth" value="${block.shieldhealth}"></label>
                    <label>Health Regen per Sec: <input type="number" id="regen" value="${block.shieldregen}"></label>
                    <label>Delay: <input type="number" id="delay" value="${block.shielddelay}"></label>
                    <label>Color: <input type="color" id="color" value="${block.shieldcolor}"></label>
                    <label>Damaged Color: <input type="color" id="damagedColor" value="${block.shielddamagedColor}"></label>
                `;
            } else if (block.typeargs === 'Tractor') {
                attributesHTML += `
                    <label>Tractor Range: <input type="number" id="tractorRange" value="${block.tractorRange}"></label>
                `;
            }
            if (!block.shrouds) block.shrouds = [];
            if (!block.fragments) block.fragments = [];

            // Repopulate shroud list
            block.shrouds.forEach((shroud, index) => {
                let shroudItem = document.createElement("li");
                shroudItem.innerHTML = `
                    <label>Size: <input type="text" class="shroud-size" value="${shroud.size}" data-index="${index}"></label>
                    <label>Offset: <input type="text" class="shroud-offset" value="${shroud.offset}" data-index="${index}"></label>
                    <label>Taper: <input type="number" class="shroud-taper" value="${shroud.taper}" data-index="${index}"></label>
                    <label>Shape: <select class="shroud-shape" data-index="${index}">
                        <option value="SQUARE" ${shroud.shape === "SQUARE" ? "selected" : ""}>SQUARE</option>
                        <option value="HEXAGON" ${shroud.shape === "HEXAGON" ? "selected" : ""}>HEXAGON</option>
                    </select></label>
                    <button onclick="removeShroud(${index})">Remove</button>
                `;
                shroudList.appendChild(shroudItem);
            });

            // Repopulate fragment list if it's a cannon
            if (block.typeargs === 'Cannon') {
                block.fragments.forEach((fragment, index) => {
                    let fragmentItem = document.createElement("li");
                    fragmentItem.innerHTML = `
                        <label>Spread: <input type="number" class="fragment-spread" value="${fragment.spread}" data-index="${index}"></label>
                        <label>Range: <input type="number" class="fragment-range" value="${fragment.range}" data-index="${index}"></label>
                        <button onclick="removeFragment(${index})">Remove</button>
                    `;
                    fragmentList.appendChild(fragmentItem);
                });
                fragmentList.innerHTML += `<button onclick="addFragment()">Add Fragment</button>`;
            }

            attributesHTML += `<button onclick="saveBlock()">Add Block</button>`;
            blockAttributesDiv.innerHTML += blockAttributesHTML;
            featureAttributesDiv.innerHTML += attributesHTML;
            shroudList.innerHTML += shroudListHTML;
        }

        function addShroud() {
            let block = blocks.find(b => b.name === document.getElementById('name').value);
            if (!block) return;

            if (!block.shrouds) block.shrouds = [];

            let shroudList = document.getElementById("shroudList");
            let shroudIndex = block.shrouds.length;
            let shroudItem = document.createElement("li");

            shroudItem.innerHTML = `
                <label>Size: <input type="text" class="shroud-size" value="{10,10}" data-index="${shroudIndex}"></label>
                <label>Offset: <input type="text" class="shroud-offset" value="{0,0,0}" data-index="${shroudIndex}"></label>
                <label>Taper: <input type="number" class="shroud-taper" value="1" data-index="${shroudIndex}"></label>
                <label>Shape: <select class="shroud-shape" data-index="${shroudIndex}">
                    <option value="TRI">TRI</option>
                    <option value="SQUARE">SQUARE</option>
                    <option value="PENTAGON">PENTAGON</option>
                    <option value="HEXAGON">HEXAGON</option>
                    <option value="HEPTAGON">HEPTAGON</option>
                    <option value="OCTAGON">OCTAGON</option>
                    <option value="COMMAND">COMMAND</option>
                </select></label>
                <button onclick="removeShroud(${shroudIndex})">Remove</button>
            `;

            shroudList.appendChild(shroudItem);

            block.shrouds.push({
                size: document.querySelector(`.shroud-size[data-index="${shroudIndex}"]`).value,
                offset: document.querySelector(`.shroud-offset[data-index="${shroudIndex}"]`).value,
                taper: document.querySelector(`.shroud-taper[data-index="${shroudIndex}"]`).value,
                shape: document.querySelector(`.shroud-shape[data-index="${shroudIndex}"]`).value
            });
        }

        function addFragment() {
            let block = blocks.find(b => b.name === document.getElementById('name').value);
            if (!block || block.typeargs !== "Cannon") return;

            if (!block.fragments) block.fragments = [];

            let fragmentList = document.getElementById("fragmentList");
            let fragmentIndex = block.fragments.length;
            let fragmentItem = document.createElement("li");

            fragmentItem.innerHTML = `
                <label>Spread: <input type="number" class="fragment-spread" value="0.2" data-index="${fragmentIndex}"></label>
                <label>Range: <input type="number" class="fragment-range" value="200" data-index="${fragmentIndex}"></label>
                <label>Damage: <input type="number" class="fragment-damage" value="10" data-index="${fragmentIndex}"></label>
                <label>Shot Velocity: <input type="number" class="fragment-muzzleVel" value="500" data-index="${fragmentIndex}"></label>
                <label>Projectile Size: <input type="number" class="fragment-projectileSize" value="1" data-index="${fragmentIndex}"></label>
                <label>Rounds Per Burst: <input type="number" class="fragment-roundsPerBurst" value="3" data-index="${fragmentIndex}"></label>
                <button onclick="removeFragment(${fragmentIndex})">Remove</button>
            `;

            fragmentList.appendChild(fragmentItem);

            block.fragments.push({
                spread: document.querySelector(`.fragment-spread[data-index="${fragmentIndex}"]`).value,
                range: document.querySelector(`.fragment-range[data-index="${fragmentIndex}"]`).value,
                damage: document.querySelector(`.fragment-damage[data-index="${fragmentIndex}"]`).value,
                muzzleVel: document.querySelector(`.fragment-muzzleVel[data-index="${fragmentIndex}"]`).value,
                projectileSize: document.querySelector(`.fragment-projectileSize[data-index="${fragmentIndex}"]`).value,
                roundsPerBurst: document.querySelector(`.fragment-roundsPerBurst[data-index="${fragmentIndex}"]`).value
            });
        }

        function removeFragment(index) {
            const block = blocks.find(b => b.name === document.getElementById('name').value);
            if (block && block.fragments) {
                // Remove the fragment element from the DOM
                const fragmentList = document.getElementById('fragmentList');
                const fragmentElements = fragmentList.getElementsByTagName('li');
                if (fragmentElements[index]) {
                    fragmentElements[index].remove();
                }
                
                // Remove the fragment from the data
                block.fragments.splice(index, 1);
                
                // Update indices of remaining fragments
                const remainingInputs = fragmentList.querySelectorAll('input');
                remainingInputs.forEach(input => {
                    const currentIndex = parseInt(input.dataset.index);
                    if (currentIndex > index) {
                        input.dataset.index = currentIndex - 1;
                    }
                });
            }
        }

        function removeShroud(index) {
            const block = blocks.find(b => b.name === document.getElementById('name').value);
            if (block) {
                block.shrouds.splice(index, 1);
                renderAttributes(block); // Re-render attributes
            }
        }

        function saveBlock() {
            let block = {
                typeargs: document.querySelector('h4').textContent.split(' ')[0],
                generalargs: document.querySelector('h5').textContent.split(' ')[0],
                name: document.getElementById('name').value,
                shape: document.getElementById('shape').value,
                size: document.getElementById('size').value,
                group: document.getElementById('group').value,
                points: document.getElementById('points').value,
                id: document.getElementById('id').value,
                health: document.getElementById('health').value,
                capacity: document.getElementById('capacity').value,
                points: document.getElementById('points').value,
                fillColor1: document.getElementById('fillColor1').value,
                fillColor2: document.getElementById('fillColor2').value,
                lineColor: document.getElementById('lineColor').value,
                density: document.getElementById('density').value,
                spread: document.getElementById('spread').value,
                projectileSize: document.getElementById('projectileSize').value,
                roundsPerBurst: document.getElementById('roundsPerBurst').value,
                burstiness: document.getElementById('burstiness').value,
                shrouds: [],
                fragments: []
            };
            if (block.typeargs === "Cannon") {
                Object.assign(block, {
                    cannondmg: document.getElementById('damage').value,
                    cannonrounds: document.getElementById('roundsPerSec').value,
                    cannonrange: document.getElementById('range').value,
                    cannonvel: document.getElementById('muzzleVel').value,
                    cannonpower: document.getElementById('power').value,
                    turreted: document.getElementById('turreted').value,
                });
            } else if (block.typeargs === "Generator") {
                Object.assign(block, {
                    powerCapacity: document.getElementById('powerCapacity').value,
                    generatorCapacityPerSec: document.getElementById('generatorCapacityPerSec').value,
                });
            } else if (block.typeargs === "Command") {
                Object.assign(block, {
                    faction: document.getElementById('faction').value,
                });
            } else if (block.typeargs === "Thruster") {
                Object.assign(block, {
                    thrust: document.getElementById('thrust').value,
                });
            } else if (block.typeargs === "Laser") {
                Object.assign(block, {
                    laserdmg: document.getElementById('laserdamage').value,
                    laserrange: document.getElementById('laserrange').value,
                    laserwidth: document.getElementById('laserwidth').value,
                    laserpower: document.getElementById('laserpower').value,
                    lasercolor: document.getElementById('lasercolor'),
                    turreted: document.getElementById('turreted').value,
                });
            } else if (block.typeargs === "Shield") {
                Object.assign(block, {
                    shieldradius: document.getElementById('radius').value,
                    shieldpower: document.getElementById('power').value,
                    shieldhealth: document.getElementById('shieldhealth').value,
                    shieldregen: document.getElementById('regen').value,
                    shielddelay: document.getElementById('delay').value,
                    shieldcolor: document.getElementById('color').value,
                    shielddamagedColor: document.getElementById('damagedColor').value,
                });
            } else if (block.typeargs === "Tractor") {
                Object.assign(block, {
                    tractorRange: document.getElementById('tractorRange').value,
                });
            }
            blocks.push(block);

            let shroudElements = document.querySelectorAll("#shroudList li");
            block.shrouds = Array.from(shroudElements).map(li => ({
                size: li.querySelector(".shroud-size").value,
                offset: li.querySelector(".shroud-offset").value,
                taper: li.querySelector(".shroud-taper").value,
                shape: li.querySelector(".shroud-shape").value
            }));

            updateBlockList();
        }

        function deleteBlock(index) {
            if (confirm("Are you sure you want to delete this block?")) {
                blocks.splice(index, 1);
                updateBlockList();
            }
        }

        function cloneBlock(index) {
        const blockToClone = blocks[index];
        const clonedBlock = { 
            ...blockToClone, 
            id: blocks.length + 1, 
            name: `${blockToClone.name} (Clone)`,
            shape: blockToClone.shape,
            size: blockToClone.size,
            group: blockToClone.group,
            fillColor1: blockToClone.fillColor1,
            fillColor2: blockToClone.fillColor2,
            lineColor: blockToClone.lineColor,
            capacity: blockToClone.capacity,
            points: blockToClone.points,
            cannondmg: blockToClone.cannondmg,
            cannonrounds: blockToClone.cannonrounds,
            cannonrange: blockToClone.cannonrange,
            cannonvel: blockToClone.cannonvel,
            cannonpower: blockToClone.cannonpower,
            laserdmg: blockToClone.laserdmg,
            laserrange: blockToClone.laserrange,
            laserwidth: blockToClone.laserwidth,
            laserpower: blockToClone.laserpower,
            lasercolor: blockToClone.lasercolor,
            turreted: blockToClone.turreted,
            health: blockToClone.health,
            powerCapacity: blockToClone.powerCapacity,
            generatorCapacityPerSec: blockToClone.generatorCapacityPerSec,
            faction: blockToClone.faction,
            thrust: blockToClone.thrust,
            shieldradius: blockToClone.shieldradius,
            shieldpower: blockToClone.shieldpower,
            shieldhealth: blockToClone.shieldhealth,
            shieldregen: blockToClone.shieldregen,
            shielddelay: blockToClone.shielddelay,
            shieldcolor: blockToClone.shieldcolor,
            shielddamagedColor: blockToClone.shielddamagedColor,
            density: blockToClone.density,
            shroudsize: blockToClone.shroudsize,
            shroudoffset: blockToClone.shroudoffset,
            shroudtaper: blockToClone.shroudtaper,
            shroudshape: blockToClone.shroudshape,
            tractorRange: blockToClone.tractorRange,
            spread: blockToClone.spread,
            projectileSize: blockToClone.projectileSize,
            roundsPerBurst: blockToClone.roundsPerBurst,
            burstiness: blockToClone.burstiness,
        };
        blocks.push(clonedBlock);
        updateBlockList();

    }

        function updateBlockList() {
            const blockList = document.getElementById('blockList');
            blockList.innerHTML = '';
            blocks.forEach((block, index) => {
                let button = document.createElement('button');
                button.textContent = `${block.name} (${block.typeargs})`;
                button.onclick = () => renderAttributes(blocks[index]);
                blockList.appendChild(button);
                
                let deleteBtn = document.createElement('button');
                deleteBtn.textContent = "Delete";
                deleteBtn.style.background = "red";
                deleteBtn.style.color = "white";
                deleteBtn.onclick = () => deleteBlock(index);
                blockList.appendChild(deleteBtn);

                let cloneBtn = document.createElement('button');
                cloneBtn.textContent = "Clone";
                cloneBtn.style.background = "orange";
                cloneBtn.style.color = "white";
                cloneBtn.onclick = () => cloneBlock(index);
                blockList.appendChild(cloneBtn);
            });
        }

    function hexToLuaColor(hex) {
        return '0x' + hex.slice(1);
    }

    function exportBlocks() {
        let luaCode = `{\n`;
        blocks.forEach((block) => {
            luaCode += `    {${block.id},\n`;
            luaCode += `        group = ${block.group},\n`;
            luaCode += `        name = "${block.name}",\n`;
            luaCode += `        fillColor = ${hexToLuaColor(block.fillColor1)},\n`;
            luaCode += `        fillColor1 = ${hexToLuaColor(block.fillColor2)},\n`;
            luaCode += `        lineColor = ${hexToLuaColor(block.lineColor)},\n`;
            luaCode += `        capacity = ${block.capacity},\n`;
            luaCode += `        durability = ${block.health},\n`;
            luaCode += `        density = ${block.density},\n`;
            luaCode += `        shape = ${block.shape},\n`;
            luaCode += `        scale = ${block.size},\n`;
            luaCode += `        points = ${block.points},\n`;
            if (block.typeargs === 'Cannon') {
                if (block.turreted === 'True') {
                    luaCode += `        features = PALETTE|CANNON|TURRET,\n`;
                } else if (block.turreted === 'False') {
                    luaCode += `        features = PALETTE|CANNON,\n`;
                }
                luaCode += `        cannon = {\n`;
                luaCode += `            damage = ${block.cannondmg || 0},\n`;
                luaCode += `            roundsPerSec = ${block.cannonrounds || 0},\n`;
                luaCode += `            range = ${block.cannonrange || 0},\n`;
                luaCode += `            muzzleVel = ${block.cannonvel || 0},\n`;
                luaCode += `            power = ${block.cannonpower || 0},\n`;
                luaCode += `            spread = ${block.spread || 0},\n`;
                luaCode += `            projectileSize = ${block.projectileSize || 1},\n`;
                luaCode += `            roundsPerBurst = ${block.roundsPerBurst || 1},\n`;
                luaCode += `            burstyness = ${block.burstiness || 0}`;

                // Handle fragments with proper nesting
                if (block.fragments && block.fragments.length > 0) {
                    let fragmentString = '';
                    // Process fragments in reverse to create nested structure
                    for (let i = block.fragments.length - 1; i >= 0; i--) {
                        const fragment = block.fragments[i];
                        if (i === block.fragments.length - 1) {
                            // Last fragment (innermost)
                            fragmentString = `,\n            fragment = {\n` +
                                `                spread = ${fragment.spread || 0},\n` +
                                `                range = ${fragment.range || 0},\n` +
                                `                damage = ${fragment.damage || 0},\n` +
                                `                muzzleVel = ${fragment.muzzleVel || 0},\n` +
                                `                projectileSize = ${fragment.projectileSize || 1},\n` +
                                `                roundsPerBurst = ${fragment.roundsPerBurst || 1}\n` +
                                `            }`;
                        } else {
                            // Wrap previous fragment string in new fragment
                            fragmentString = `,\n            fragment = {\n` +
                                `                spread = ${fragment.spread || 0},\n` +
                                `                range = ${fragment.range || 0},\n` +
                                `                damage = ${fragment.damage || 0},\n` +
                                `                muzzleVel = ${fragment.muzzleVel || 0},\n` +
                                `                projectileSize = ${fragment.projectileSize || 1},\n` +
                                `                roundsPerBurst = ${fragment.roundsPerBurst || 1}` +
                                fragmentString + `\n            }`;
                        }
                    }
                    luaCode += fragmentString;
                }
                luaCode += `\n        },\n`;
            } else if (block.typeargs === 'Laser') {
                if (block.turreted === 'True') {
                    luaCode += `        features = PALETTE|LASER|TURRET,\n`;
                } else if (block.turreted === 'False') {
                    luaCode += `        features = PALETTE|LASER,\n`;
                }
                luaCode += `        laser = {\n`;
                luaCode += `            damage = ${block.laserdmg},\n`;
                luaCode += `            range = ${block.laserrange},\n`;
                luaCode += `            width = ${block.laserwidth},\n`;
                luaCode += `            power = ${block.laserpower},\n`;
                luaCode += `            color = ${hexToLuaColor(block.lasercolor)},\n`;
                luaCode += `        },\n`;
            } else if (block.typeargs === 'Armor') {
                luaCode += `        features = PALETTE,\n`;
            } else if (block.typeargs === 'Generator') {
                luaCode += `        features = PALETTE|GENERATOR,\n`;
                luaCode += `        powerCapacity = ${block.powerCapacity},\n`;
                luaCode += `        generatorCapacityPerSec = ${block.generatorCapacityPerSec},\n`;
            } else if (block.typeargs === 'Command') {
                luaCode += `        features = COMMAND|ASSEMBLER|TRACTOR,\n`;
                luaCode += `        command = {\n`;
                luaCode += `            faction = ${block.faction},\n`;
                luaCode += `        tractorRange = 600,\n`;
                luaCode += `        },\n`;
            } else if (block.typeargs === 'Thruster') {
                luaCode += `        features = PALETTE|THRUSTER,\n`;
                luaCode += `        thrusterForce = ${block.thrust},\n`;
            } else if (block.typeargs === 'Factory') {
                luaCode += `        features = PALETTE|FACTORY,\n`;
            } else if (block.typeargs === 'Shield') {
                luaCode += `        features = PALETTE|SHIELD,\n`;
                luaCode += `        shield = {\n`;
                luaCode += `            radius = ${block.shieldradius},\n`;
                luaCode += `            strenght = ${block.shieldhealth},\n`;
                luaCode += `            regen = ${block.shieldregen},\n`;
                luaCode += `            delay = ${block.shielddelay},\n`;
                luaCode += `            color = ${hexToLuaColor(block.shieldcolor)},\n`;
                luaCode += `            damagedColor = ${hexToLuaColor(block.shielddamagedColor)},\n`;
                luaCode += `        },\n`;
            } else if (block.typeargs === 'Tractor') {
                luaCode += `        features = PALETTE|TRACTOR,\n`;
                luaCode += `        tractorRange = ${block.tractorRange},\n`;
            }
            if (block.shrouds && block.shrouds.length > 0) {
                luaCode += `        shroud = {\n`;
                block.shrouds.forEach((shroud, index) => {
                    luaCode += `            {size = ${shroud.size}, offset = ${shroud.offset}, taper = ${shroud.taper}, shape = ${shroud.shape}}`;
                    if (index < block.shrouds.length - 1) {
                        luaCode += `,`;
                    }
                    luaCode += `\n`;
                });
                luaCode += `        },\n`;
            }

            luaCode += `    },\n`;
        });
        luaCode += `}`;

        const blob = new Blob([luaCode], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'blocks.lua';
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadBlocks() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.lua';
        input.onchange = async (event) => {
            const file = event.target.files[0];
            if (file) {
                const text = await file.text();
                parseLuaBlocks(text);
            }
        };
        input.click();
    }

    function parseLuaBlocks(luaCode) {
    const blockRegex = /{\s*(\d+),([\s\S]*?)\s*},/g;
    let match;

    blocks = []; // Clear existing blocks

    while ((match = blockRegex.exec(luaCode)) !== null) {
        let block = { id: parseInt(match[1]), typeargs: "", turreted: "False" };
        let attributes = match[2];

        // Extract key-value pairs
        attributes.split("\n").forEach(line => {
            let keyValue = line.match(/\s*(\w+)\s*=\s*(.*?),/);
            if (keyValue) {
                let key = keyValue[1].trim();
                let value = keyValue[2].trim().replace(/"|,/g, "");

                // Handle special cases
                if (key === "name" || key === "shape") {
                    block[key] = value;
                } else if (key === "features") {
                    if (value.includes("CANNON")) block.typeargs = "Cannon";
                    if (value.includes("LASER")) block.typeargs = "Laser";
                    if (value.includes("TURRET")) block.turreted = "True";
                    if (value.includes("GENERATOR")) block.typeargs = "Generator";
                    if (value.includes("COMMAND")) block.typeargs = "Command";
                    if (value.includes("THRUSTER")) block.typeargs = "Thruster";
                    if (value.includes("FACTORY")) block.typeargs = "Factory";
                    if (value.includes("SHIELD")) block.typeargs = "Shield";
                    
                } else if (key === "cannon") {
                    let cannonStats = value.match(/damage\s*=\s*(\d+).*?roundsPerSec\s*=\s*(\d+).*?range\s*=\s*(\d+)/s);
                    if (cannonStats) {
                        block.cannondmg = parseInt(cannonStats[1]);
                        block.cannonrounds = parseInt(cannonStats[2]);
                        block.cannonrange = parseInt(cannonStats[3]);
                    }
                } else if (key === "laser") {
                    let laserStats = value.match(/damage\s*=\s*(\d+).*?range\s*=\s*(\d+)/s);
                    if (laserStats) {
                        block.laserdmg = parseInt(laserStats[1]);
                        block.laserrange = parseInt(laserStats[2]);
                    }
                } else if (!isNaN(value)) {
                    block[key] = parseFloat(value);
                }
            }
        });

        blocks.push(block);
    }

    updateBlockList(); // Refresh UI
}

</script>
</body>
</html>